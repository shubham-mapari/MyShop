{% extends 'shop/base.html' %}

{% block title %}Pay for Order #{{ order.id }}{% endblock %}

{% block content %}
<style>
    .payment-container {
        max-width: 600px;
        margin: 50px auto;
        background: white;
        border-radius: 16px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        overflow: hidden;
        text-align: center;
    }
    .payment-header {
        background: linear-gradient(135deg, #b57a50, #8d5a3a);
        color: white;
        padding: 30px 20px;
    }
    .payment-header h2 {
        margin: 0;
        font-size: 1.8rem;
    }
    .payment-header p {
        margin: 5px 0 0;
        opacity: 0.9;
    }
    .payment-body {
        padding: 30px;
    }
    .amount-display {
        font-size: 3rem;
        font-weight: 700;
        color: #3a3128;
        margin-bottom: 20px;
    }
    .payment-instructions {
        color: #666;
        margin-bottom: 25px;
        line-height: 1.6;
    }
    .btn-pay-razorpay {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #28a745, #218838);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1.2rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 16px rgba(40, 167, 69, 0.3);
    }
    .btn-pay-razorpay:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    }
    .payment-footer {
        background: #f9f6f2;
        padding: 15px;
        font-size: 0.9rem;
        color: #666;
    }
    #statusMsg {
        margin-top: 20px;
        font-weight: 600;
        color: #dc3545;
    }
    .loader-icon {
        display: none;
        margin: 20px auto;
        font-size: 2rem;
        color: #b57a50;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>

<div class="container my-5">
    <div class="payment-container">
        <div class="payment-header">
            <h2>Complete Your Payment</h2>
            <p>Order #{{ order.id }}</p>
        </div>
        <div class="payment-body">
            <p class="payment-instructions">You are about to pay:</p>
            <div class="amount-display">â‚¹{{ order.total_amount|floatformat:2 }}</div>
            <p class="payment-instructions">
                Click the button below to open a secure payment window. You can pay via UPI, Card, Netbanking, or Wallets.
            </p>
            <button id="payBtn" class="btn-pay-razorpay">
                <i class="fas fa-shield-alt"></i> Pay Securely
            </button>
            <i class="fas fa-spinner loader-icon" id="loader"></i>
            <div id="statusMsg"></div>
        </div>
        <div class="payment-footer">
            <i class="fas fa-lock"></i> All transactions are secure and encrypted.
        </div>
    </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  async function fetchOrderConfig(){
    const resp = await fetch("{% url 'payment_create' order.id %}");
    const data = await resp.json();
    if(!resp.ok || !data.ok){
      throw new Error(data.message || 'Failed to initialize payment');
    }
    return data;
  }

  function verifyPayment(payload){
    const formData = new FormData();
    formData.append('razorpay_payment_id', payload.razorpay_payment_id || '');
    formData.append('razorpay_order_id', payload.razorpay_order_id || '');
    formData.append('razorpay_signature', payload.razorpay_signature || '');
    return fetch("{% url 'payment_verify' %}", { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' }})
      .then(r => r.json());
  }

  async function startPayment(){
    const status = document.getElementById('statusMsg');
    const loader = document.getElementById('loader');
    loader.style.display = 'block';
    document.getElementById('payBtn').style.display = 'none';
    status.textContent = '';
    try{
      const cfg = await fetchOrderConfig();
      const options = {
        key: cfg.key,
        amount: cfg.amount,
        currency: cfg.currency,
        name: cfg.name,
        description: cfg.description,
        order_id: cfg.order_id,
        prefill: cfg.prefill || {},
        notes: cfg.notes || {},
        theme: cfg.theme || {},
        method: { upi: true, card: true, netbanking: true, wallet: true },
        config: { display: { blocks: { upi: { name: 'Pay via UPI', instruments: [{ method: 'upi' }] } }, sequence: ['upi', 'cards', 'netbanking', 'wallet'], preferences: { show_default_blocks: true } } },
        handler: async function (response){
          status.textContent = 'Verifying payment...';
          const res = await verifyPayment(response);
          if(res.ok){
            window.location.href = "{% url 'order_success' order.id %}";
          } else {
            status.textContent = res.message || 'Verification failed. Try again.';
          }
        },
        modal: {
          ondismiss: function(){ status.textContent = 'Payment cancelled. You can try again.'; }
        }
      };
      const rzp = new Razorpay(options);
      try { rzp.open(); } catch(e){ status.textContent = 'Unable to open payment window.'; }
      loader.style.display = 'none';
      document.getElementById('payBtn').style.display = 'block';
    } catch(err){
      status.textContent = (err && err.message) ? err.message : 'Failed to initialize payment.';
      loader.style.display = 'none';
      document.getElementById('payBtn').style.display = 'block';
    }
  }

  document.getElementById('payBtn').addEventListener('click', startPayment);
  
  // Automatically trigger payment for a seamless experience
  window.addEventListener('load', () => {
      setTimeout(startPayment, 500); // Short delay to allow page to render
  });
</script>
{% endblock %}
